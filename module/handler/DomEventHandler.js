import{inherits as e,createSuper as t,classCallCheck as n,createClass as a,slicedToArray as o,toConsumableArray as r,toArray as i}from"../_virtual/_rollupPluginBabelHelpers.js";import l from"./BaseHandler.js";import s,{CHECK_DOM_EVENT_PATTERN as u,SAPARATOR as c,NAME_SAPARATOR as v,CHECK_SAPARATOR as h,DOM_EVENT_SAPARATOR as d}from"../Event.js";import{isNotUndefined as f,isFunction as m,splitMethodByKeyword as k,debounce as g,throttle as b}from"../functions/func.js";import y from"../functions/Dom.js";var E={touchstart:!0,touchmove:!0,mousedown:!0,mouseup:!0,mousemove:!0},p={doubletab:"touchend"},D={doubletab:!0},C=function(C){e(x,l);var M=t(x);function x(){return n(this,x),M.apply(this,arguments)}return a(x,[{key:"initialize",value:function(){var e=this;this.destroy(),this._domEvents||(this._domEvents=this.context.filterProps(u)),this._domEvents.forEach((function(t){return e.parseDomEvent(t)}))}},{key:"destroy",value:function(){this.removeEventAll()}},{key:"removeEventAll",value:function(){var e=this;this.getBindings().forEach((function(t){e.removeDomEvent(t)})),this.initBindings()}},{key:"removeDomEvent",value:function(e){var t=e.eventName,n=e.dom,a=e.callback;s.removeDomEvent(n,t,a)}},{key:"getBindings",value:function(){return this._bindings||this.initBindings(),this._bindings}},{key:"addBinding",value:function(e){this.getBindings().push(e)}},{key:"initBindings",value:function(){this._bindings=[]}},{key:"matchPath",value:function(e,t){return e?e.matches(t)?e:this.matchPath(e.parentElement,t):null}},{key:"hasDelegate",value:function(e,t){return this.matchPath(e.target||e.srcElement,t.delegate)}},{key:"makeCallback",value:function(e,t){return e.delegate?this.makeDelegateCallback(e,t):this.makeDefaultCallback(e,t)}},{key:"makeDefaultCallback",value:function(e,t){var n=this;return function(a){var o=n.runEventCallback(a,e,t);if(f(o))return o}}},{key:"makeDelegateCallback",value:function(e,t){var n=this;return function(a){var o=n.hasDelegate(a,e);if(o){a.$dt=y.create(o);var r=n.runEventCallback(a,e,t);if(f(r))return r}}}},{key:"runEventCallback",value:function(e,t,n){var a=this.context;if(e.xy=s.posXY(e),t.beforeMethods.length&&t.beforeMethods.every((function(t){return a[t.target].call(a,e,t.param)})),this.checkEventType(e,t)){var o=n(e,e.$dt,e.xy);return!1!==o&&t.afterMethods.length&&t.afterMethods.forEach((function(t){return a[t.target].call(a,e,t.param)})),o}}},{key:"checkEventType",value:function(e,t){var n=this.context,a=!0;t.codes.length&&(a=!!e.code&&t.codes.indexOf(e.code.toLowerCase())>-1||!!e.key&&t.codes.indexOf(e.key.toLowerCase())>-1);var o=!0;return t.checkMethodList.length&&(o=t.checkMethodList.every((function(t){var a=n[t];return m(a)&&a?a.call(n,e):!f(a)||!!a}))),a&&o}},{key:"getDefaultDomElement",value:function(e){var t,n=this.context;return(t=e?n.refs[e]||n[e]||window[e]:n.el||n.$el||n.$root)instanceof y?t.getElement():t}},{key:"getRealEventName",value:function(e){return p[e]||e}},{key:"getCustomEventName",value:function(e){return D[e]?e:""}},{key:"getDefaultEventObject",value:function(e,t){var n=this.context,a=t,i=a.filter((function(e){return!!n[e]})),l=k(a,"after"),s=o(l,2),u=s[0],c=s[1],v=k(a,"before"),h=o(v,2),d=h[0],f=h[1],m=k(a,"debounce"),g=o(m,2),b=g[0],y=g[1],E=k(a,"delay"),p=o(E,2),D=p[0],C=p[1],M=k(a,"throttle"),x=o(M,2),N=x[0],B=x[1],j=k(a,"capture"),w=o(j,1)[0],_=[].concat(r(i),r(u),r(d),r(D),r(b),r(N),r(w)),T=a.filter((function(e){return-1===_.indexOf(e)})).map((function(e){return e.toLowerCase()}));return{eventName:this.getRealEventName(e),customEventName:this.getCustomEventName(e),codes:T,captures:w,afterMethods:c,beforeMethods:f,delayMethods:C,debounceMethods:y,throttleMethods:B,checkMethodList:i}}},{key:"addDomEvent",value:function(e,t){e.callback=this.makeCallback(e,t),this.addBinding(e);var n=!!e.captures.length;E[e.eventName]&&(n={passive:!0,capture:n}),s.addDomEvent(e.dom,e.eventName,e.callback,n)}},{key:"makeCustomEventCallback",value:function(e,t){var n=this;if("doubletab"===e.customEventName){var a=300;return e.delayMethods.length&&(a=+e.delayMethods[0].target),function(){n.doubleTab?(performance.now()-n.doubleTab.time<a&&t.apply(void 0,arguments),n.doubleTab=null):n.doubleTab={time:performance.now()}}}return t}},{key:"bindingDomEvent",value:function(e,t,n){var a=i(e),o=a[0],r=a[1],l=a.slice(2),s=this.getDefaultEventObject(o,t);if(s.dom=this.getDefaultDomElement(r),s.delegate=l.join(c),s.debounceMethods.length){var u=+s.debounceMethods[0].target;n=g(n,u)}else if(s.throttleMethods.length){var v=+s.throttleMethods[0].target;n=b(n,v)}n=this.makeCustomEventCallback(s,n),this.addDomEvent(s,n)}},{key:"getEventNames",value:function(e){var t=[];return e.split(v).forEach((function(e){var n=e.split(v);t.push.apply(t,n)})),t}},{key:"parseDomEvent",value:function(e){for(var t=this.context,n=e.split(h).map((function(e){return e.trim()})).filter(Boolean),a=n.shift().split(d)[1].split(c),o=this.getEventNames(a[0]),r=t[e].bind(t),i=0,l=o.length;i<l;i++)a[0]=o[i],this.bindingDomEvent(a,n,r)}}]),x}();export{C as default};
