import{defineProperty as e,createClass as t,taggedTemplateLiteral as r,createForOfIteratorHelper as n,objectSpread2 as i,slicedToArray as a,toConsumableArray as s,classCallCheck as o,asyncToGenerator as l,toArray as u}from"./_virtual/_rollupPluginBabelHelpers.js";import{getRef as c,CHECK_LOAD_PATTERN as h,LOAD_SAPARATOR as f,CHECK_SAPARATOR as p,DOMDIFF as d}from"./Event.js";import v from"./functions/Dom.js";import{isString as y,html as m,keyEach as k,isFunction as g,collectProps as _}from"./functions/func.js";import b from"./handler/DomEventHandler.js";import $ from"./handler/BindHandler.js";import{retriveElement as S}from"./functions/registElement.js";import{uuid as C,uuidShort as M}from"./functions/uuid.js";var P,T,j,w=v.create("div"),A="[".concat("ref","]"),E="[".concat("refclass","]"),K=(e(P={constructor:!0,initState:!0,updateData:!0},"constructor",!0),e(P,"initializeProperty",!0),e(P,"created",!0),e(P,"getRealEventName",!0),e(P,"initializeStoreEvent",!0),e(P,"destoryStoreEvent",!0),e(P,"destroy",!0),e(P,"emit",!0),e(P,"trigger",!0),e(P,"on",!0),e(P,"off",!0),e(P,"setState",!0),e(P,"_reload",!0),e(P,"render",!0),e(P,"initialize",!0),e(P,"afterRender",!0),e(P,"components",!0),e(P,"getRef",!0),e(P,"parseTemplate",!0),e(P,"parseProperty",!0),e(P,"parseSourceName",!0),e(P,"parseComponent",!0),e(P,"clean",!0),e(P,"refresh",!0),e(P,"load",!0),e(P,"bindData",!0),e(P,"template",!0),e(P,"eachChildren",!0),e(P,"destroy",!0),e(P,"collectProps",!0),e(P,"filterProps",!0),e(P,"self",!0),e(P,"isAltKey",!0),e(P,"isCtrlKey",!0),e(P,"isShiftKey",!0),e(P,"isMetaKey",!0),e(P,"preventDefault",!0),e(P,"stopPropagation",!0),e(P,"bodyMouseMove",!0),e(P,"bodyMouseUp",!0),P),R=function(){function v(e,t){o(this,v),this.state={},this.prevState={},this.refs={},this.children={},this._bindings=[],this.id=C(),this.__tempVariables=new Map,this.handlers=this.initializeHandler(),this.initializeProperty(e,t),this.initComponents()}var P;return t(v,[{key:"initializeProperty",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.opt=e||{},this.parent=this.opt,this.props=t,this.source=C(),this.sourceName=this.constructor.name}},{key:"initComponents",value:function(){this.childComponents=this.components()}},{key:"initializeHandler",value:function(){return[new $(this),new b(this)]}},{key:"initState",value:function(){return{}}},{key:"setState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.prevState=this.state,this.state=Object.assign({},this.state,e),t&&this.load()}},{key:"toggleState",value:function(t){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.setState(e({},t,!this.state[t]),r)}},{key:"variable",value:function(e){var t="".concat("__ref__variable:").concat(M());return this.__tempVariables.set(t,e),t}},{key:"recoverVariable",value:function(e){if(!1===y(e))return e;var t=e;return this.__tempVariables.has(e)&&(t=this.__tempVariables.get(e),this.__tempVariables.delete(e)),t}},{key:"_reload",value:function(e){this.props=e,this.state={},this.setState(this.initState(),!1),this.refresh(!0)}},{key:"render",value:function(e){this.$el=this.parseTemplate(m(T||(T=r(["\n        ","\n      "])),this.template())),this.refs.$el=this.$el,e&&e.append(this.$el),this.load(),this.afterRender()}},{key:"initialize",value:function(){this.state=this.initState()}},{key:"afterRender",value:function(){}},{key:"components",value:function(){return{}}},{key:"getRef",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t.join("");return this.refs[n]}},{key:"parseTemplate",value:function(e,t){Array.isArray(e)&&(e=e.join("")),e=e.trim();for(var r=w.html(e).children(),n=0,i=r.length;n<i;n++){var a=r[n],s=a.attr("ref");s&&(this.refs[s]=a);for(var o=a.$$(A),l={},u=0,c=o.length;u<c;u++){var h=o[u],f=h.attr("ref");l[f]?console.warn("".concat(s," is duplicated. - ").concat(this.sourceName),this):l[f]=!0,this.refs[f]=h}}return t?w.createChildrenFragment():r[0]}},{key:"parseProperty",value:function(e){var t,r={},s=n(e.el.attributes);try{for(s.s();!(t=s.n()).done;){var o=t.value;r[o.nodeName]=this.recoverVariable(o.nodeValue)}}catch(e){s.e(e)}finally{s.f()}return r.props&&(r=i(i({},r),c(r.props))),e.$$("property").forEach((function(e){var t=e.attrs("name","value","valueType"),n=a(t,3),i=n[0],s=n[1],o=n[2],l=s||e.text();"json"===o&&(l=JSON.parse(l)),r[i]=l})),r}},{key:"parseSourceName",value:function(e){return e.parent?[e.sourceName].concat(s(this.parseSourceName(e.parent))):[e.sourceName]}},{key:"getEventMachineComponent",value:function(e){return S(e)||this.childComponents[e]}},{key:"parseComponent",value:function(){var e=this;this.$el.$$(E).forEach((function(t){var r=e.getEventMachineComponent(t.attr("refclass"));if(r){var n,i=e.parseProperty(t),a=t.attr("ref"),s=null;if(e.children[a]?(s=e.children[a])._reload(i):(s=new r(e,i),e.children[a||s.id]=s,s.render()),s.renderTarget)null===(n=s.$el)||void 0===n||n.appendTo(s.renderTarget),t.remove();else t.replace(s.$el)}else t.remove()})),k(this.children,(function(t,r){r&&r.clean()&&delete e.children[t]}))}},{key:"clean",value:function(){if(this.$el&&!this.$el.hasParent())return k(this.children,(function(e,t){t.clean()})),this.destroy(),this.$el=null,!0}},{key:"refresh",value:function(){this.load()}},{key:"_afterLoad",value:function(){this.runHandlers("initialize"),this.bindData(),this.parseComponent()}},{key:"load",value:(P=l(regeneratorRuntime.mark((function e(){var t,n,i,a,s=this,o=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=o.length,n=new Array(t),i=0;i<t;i++)n[i]=o[i];return this._loadMethods||(this._loadMethods=this.filterProps(h)),a=this._loadMethods.filter((function(e){var t=e.split(f)[1].split(p).map((function(e){return e.trim()}))[0];return!n.length||n.indexOf(t)>-1})),e.next=5,a.forEach(function(){var e=l(regeneratorRuntime.mark((function e(t){var i,a,o,l,c,h,v,y,k;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.split(f)[1],a=i.split(p).map((function(e){return e.trim()})),o=u(a),l=o[0],c=(c=o.slice(1)).map((function(e){return e.trim()})),h=Boolean(c.filter((function(e){return d.includes(e)})).length),!s.refs[l]){e.next=11;break}return e.next=7,(v=s[t]).call.apply(v,[s].concat(n));case 7:y=e.sent,Array.isArray(y)&&(y=y.join("")),k=s.parseTemplate(m(j||(j=r(["",""])),y),!0),h?s.refs[l].htmlDiff(k):s.refs[l].html(k);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:this._afterLoad();case 6:case"end":return e.stop()}}),e,this)}))),function(){return P.apply(this,arguments)})},{key:"runHandlers",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"run",t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.handlers.forEach((function(t){return t[e].apply(t,r)}))}},{key:"bindData",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.runHandlers.apply(this,["load"].concat(t))}},{key:"template",value:function(){return"<div></div>"}},{key:"eachChildren",value:function(e){g(e)&&k(this.children,(function(t,r){e(r)}))}},{key:"rerender",value:function(){var e=this.$el.parent();this.destroy(),this.render(e)}},{key:"destroy",value:function(){this.eachChildren((function(e){e.destroy()})),this.runHandlers("destroy"),this.$el&&this.$el.remove(),this.$el=null,this.refs={},this.children={}}},{key:"collectProps",value:function(){return this.__cachedMethodList||(this.__cachedMethodList=_(this,K)),this.__cachedMethodList}},{key:"filterProps",value:function(e){return this.collectProps().filter((function(t){return t.match(e)}))}},{key:"self",value:function(e){return e&&e.$dt&&e.$dt.is(e.target)}},{key:"isAltKey",value:function(e){return e.altKey}},{key:"isCtrlKey",value:function(e){return e.ctrlKey}},{key:"isShiftKey",value:function(e){return e.shiftKey}},{key:"isMetaKey",value:function(e){return e.metaKey||"Meta"==e.key||e.code.indexOf("Meta")>-1}},{key:"isMouseLeftButton",value:function(e){return 1===e.buttons}},{key:"isMouseRightButton",value:function(e){return 2===e.buttons}},{key:"hasMouse",value:function(e){return"mouse"===e.pointerType}},{key:"hasTouch",value:function(e){return"touch"===e.pointerType}},{key:"hasPen",value:function(e){return"pen"===e.pointerType}},{key:"preventDefault",value:function(e){return e.preventDefault(),!0}},{key:"stopPropagation",value:function(e){return e.stopPropagation(),!0}}]),v}();export{R as default};
